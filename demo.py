"""
Demo script showing the LangGraph text-to-SQL agent workflow
This demonstrates the agent's functionality without requiring an OpenAI API key
"""
from text_to_sql_agent import get_database_schema, execute_sql
from sqlalchemy import create_engine
import os

def demo_agent_workflow():
    """Demonstrate the complete agent workflow"""
    print("=" * 80)
    print("ğŸ¤– LangGraph Text-to-SQL Agent Demo")
    print("=" * 80)
    
    # Step 1: Get database schema
    print("\næ­¥éª¤ 1: è·å–æ•°æ®åº“ç»“æ„ / Step 1: Get database schema")
    print("-" * 80)
    schema = get_database_schema()
    print(schema)
    
    # Step 2: Demonstrate SQL generation (simulated)
    print("\n\næ­¥éª¤ 2: ç”Ÿæˆ SQL æŸ¥è¯¢ / Step 2: Generate SQL queries")
    print("-" * 80)
    
    # Example queries that would be generated by the LLM
    example_queries = [
        {
            "question": "æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ· / Show all users",
            "sql": "SELECT * FROM users"
        },
        {
            "question": "æ‰¾å‡ºè´­ä¹°äº†ç¬”è®°æœ¬ç”µè„‘çš„ç”¨æˆ· / Find users who bought laptops",
            "sql": """SELECT DISTINCT u.name, u.email
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN products p ON o.product_id = p.id
WHERE p.name LIKE '%ç¬”è®°æœ¬ç”µè„‘%'"""
        },
        {
            "question": "ç»Ÿè®¡æ¯ä¸ªäº§å“çš„æ€»é”€é‡ / Count total sales for each product",
            "sql": """SELECT p.name, SUM(o.quantity) as total_sales
FROM products p
JOIN orders o ON p.id = o.product_id
GROUP BY p.name
ORDER BY total_sales DESC"""
        },
        {
            "question": "æ˜¾ç¤ºä»·æ ¼æœ€é«˜çš„3ä¸ªäº§å“ / Show top 3 most expensive products",
            "sql": "SELECT name, price, category FROM products ORDER BY price DESC LIMIT 3"
        }
    ]
    
    # Step 3: Execute queries and show results
    for i, example in enumerate(example_queries, 1):
        print(f"\n{'=' * 80}")
        print(f"ç¤ºä¾‹ {i} / Example {i}")
        print(f"{'=' * 80}")
        print(f"\nç”¨æˆ·é—®é¢˜ / User Question:")
        print(f"  {example['question']}")
        print(f"\nç”Ÿæˆçš„ SQL / Generated SQL:")
        print(f"  {example['sql']}")
        print(f"\næŸ¥è¯¢ç»“æœ / Query Results:")
        print("-" * 80)
        
        # Execute the query
        state = {
            "sql_query": example['sql'],
            "error": ""
        }
        result_state = execute_sql(state)
        
        if result_state.get("error"):
            print(f"âŒ {result_state['error']}")
        else:
            print(result_state["query_result"])
    
    print(f"\n{'=' * 80}")
    print("âœ… Demo completed successfully!")
    print("=" * 80)
    print("\nğŸ“ æ³¨æ„ / Note:")
    print("  è¦ä½¿ç”¨å®Œæ•´çš„æ™ºèƒ½ä½“åŠŸèƒ½ï¼Œéœ€è¦é…ç½® OPENAI_API_KEY ç¯å¢ƒå˜é‡")
    print("  To use the full agent functionality, configure the OPENAI_API_KEY environment variable")
    print("\n  ç„¶åè¿è¡Œ / Then run:")
    print("    python cli.py")
    print("=" * 80)


if __name__ == "__main__":
    demo_agent_workflow()
